<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Extracted Article Text</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Merriweather', serif;
            /* A good serif font for reading */
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&display=swap" rel="stylesheet">
</head>

<body class="bg-gray-100 py-10">
    <div class="container mx-auto bg-white rounded-lg shadow-md p-8 max-w-3xl">
        <section class="mb-8 p-4 bg-gray-50 rounded-md shadow-inner">
            <h2 class="text-xl font-semibold text-indigo-600 mb-2 text-center">Article Summary</h2>
            <div id="article-summary" class="text-gray-700 leading-relaxed text-center">
                Loading summary...
            </div>
        </section>

        <section>
            <h2 class="text-xl font-semibold text-indigo-600 mb-4 text-center">Original Article Text</h2>
            <div id="article-text" class="text-lg text-gray-800 leading-relaxed text-center">
                Loading article text...
            </div>
        </section>
    </div>

    <script>
        async function fetchArticleSummary(articleText) {
            const summaryDiv = document.getElementById('article-summary');
            summaryDiv.textContent = 'Loading summary...';

            const GEMINI_API_KEY = 'AIzaSyBfL02fCov6TNa3fkOI81RsZGWhg3j1rxg'; // **SECURITY WARNING: DO NOT HARDCODE IN PRODUCTION!**
            const geminiApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;

            try {
                const response = await fetch(geminiApiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: `summarize this news article. dont miss out on any important points or messages or topics . also provide key terms and phrases, difficult words along with their meanings, synonyms and antonyms, idioms, sentence usage:  ${articleText}`
                            }]
                        }]
                    })
                });

                if (!response.ok) {
                    console.error(`Gemini API Error: ${response.status}`, await response.text());
                    summaryDiv.textContent = 'Failed to load summary from Gemini API.';
                    return;
                }

                const data = await response.json();
                // **IMPORTANT:** Adjust this based on the actual Gemini API response structure.
                try {
                    const summary = data.candidates[0].content.parts[0].text;
                    summaryDiv.textContent = summary;
                } catch (error) {
                    console.error('Error parsing Gemini response:', error, data);
                    summaryDiv.textContent = 'Error processing summary.';
                }

            } catch (error) {
                console.error("Error calling Gemini API:", error);
                summaryDiv.textContent = 'Error loading summary.';
            }
        }

        async function fetchAndExtractArticle() {
            const urlParams = new URLSearchParams(window.location.search);
            const articleUrl = urlParams.get('url');
            const proxyUrl = "https://api.codetabs.com/v1/proxy/?quest=";
            const fullArticleUrl = proxyUrl + encodeURIComponent(articleUrl);
            const articleDiv = document.getElementById('article-text');
            let extractedArticleText = ""; // Declare it here

            try {
                const response = await fetch(fullArticleUrl);
                if (!response.ok) {
                    articleDiv.textContent = `Failed to fetch article: ${response.status}`;
                    return;
                }
                const articleHTML = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(articleHTML, 'text/html');

                const mainDiv = doc.querySelector("div._s30J.clearfix");
                if (mainDiv) {
                    const images = mainDiv.querySelectorAll('img');
                    images.forEach(img => img.remove());
                    articleDiv.innerHTML = mainDiv.innerHTML;
                    extractedArticleText = mainDiv.textContent;
                } else {
                    console.warn("Main article content selector not found. Displaying full article without specific extraction.");
                    const bodyWithoutImages = doc.body.cloneNode(true);
                    const bodyImages = bodyWithoutImages.querySelectorAll('img');
                    bodyImages.forEach(img => img.remove());
                    articleDiv.innerHTML = bodyWithoutImages.innerHTML;
                    extractedArticleText = bodyWithoutImages.textContent;
                }

                const paragraphs = articleDiv.querySelectorAll('p');
                paragraphs.forEach(p => {
                    p.classList.add('mb-4', 'text-justify');
                    p.innerHTML = p.textContent.replace(/([^\s]{120})/g, '$1<wbr>');
                });

                const headings = articleDiv.querySelectorAll('h1, h2, h3, h4, h5, h6');
                headings.forEach(h => {
                    h.classList.add('text-indigo-700', 'font-bold', 'mt-6', 'mb-2', 'text-center');
                });

                articleDiv.style.textAlign = 'center';

                // Fetch the summary after extracting the article text
                if (extractedArticleText) { // Use the correctly scoped variable
                    fetchArticleSummary(extractedArticleText);
                } else {
                    document.getElementById('article-summary').textContent = 'Could not extract article text for summary.';
                }

            } catch (error) {
                console.error("Error fetching and extracting article:", error);
                articleDiv.textContent = "Error fetching article.";
                document.getElementById('article-summary').textContent = 'Could not fetch article to summarize.';
            }
        }

        fetchAndExtractArticle();
    </script>
</body>

</html>
